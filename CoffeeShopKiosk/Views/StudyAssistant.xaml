<Window x:Class="CoffeeShopKiosk.Views.StudyAssistant"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Study Assistant" Width="520" Height="420" WindowStartupLocation="CenterOwner" ResizeMode="CanResizeWithGrip" Loaded="Window_Loaded">
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Message list -->
        <Border Grid.Row="0" Style="{StaticResource CardStyle}" Padding="10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl x:Name="MessagesList" ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Padding="8" Margin="0,4" CornerRadius="6" Background="{Binding Role, Converter={StaticResource RoleToBrush}}">
                                <StackPanel>
                                    <TextBlock Text="{Binding Text}" TextWrapping="Wrap" FontSize="{Binding DataContext.MessageFontSize, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <TextBlock Text="{Binding Source}" FontSize="10" Opacity="0.7" Margin="0,0,8,0" />
                                        <TextBlock Text="{Binding Confidence, StringFormat='Confidence: {0:P0}'}" FontSize="10" Opacity="0.7" />
                                    </StackPanel>

                                    <!-- Quick feedback buttons for assistant messages -->
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0" Visibility="{Binding Role, Converter={StaticResource RoleToBrush}, ConverterParameter=showFeedback}">
                                        <Button Content="ðŸ‘" Width="36" Height="26" Click="FeedbackYes_Click" Tag="{Binding}" />
                                        <Button Content="ðŸ‘Ž" Width="36" Height="26" Margin="6,0,0,0" Click="FeedbackNo_Click" Tag="{Binding}" />
                                    </StackPanel>

                                    <!-- Fallback actions shown when the assistant couldn't generate a full answer -->
                                    <StackPanel x:Name="FallbackActions" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,6,0,0" Visibility="Collapsed">
                                        <Button Content="Try again" Width="100" Height="26" Click="TryAgain_Click" Tag="{Binding}" Margin="0,0,6,0" />
                                        <Button Content="Suggest rephrase" Width="120" Height="26" Click="SuggestRephrase_Click" Tag="{Binding}" />
                                    </StackPanel>

                                    <!-- Sources list -->
                                    <ItemsControl ItemsSource="{Binding Sources}" Margin="0,6,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" FontSize="11" Foreground="#3A2A1F" TextDecorations="Underline" Cursor="Hand" MouseDown="SourceLink_Click" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <TextBlock Text="{Binding Timestamp, StringFormat='t'}" FontSize="10" Opacity="0.7" HorizontalAlignment="Right" />
                                </StackPanel>
                            </Border>
                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding Source}" Value="fallback">
                                    <Setter TargetName="FallbackActions" Property="Visibility" Value="Visible" />
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Input -->
        <StackPanel Grid.Row="1" Orientation="Vertical" Margin="0,8,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0,0,0,6">
                <CheckBox Content="Chat mode (free text)" IsChecked="{Binding UseChatMode}" Margin="0,0,12,0" VerticalAlignment="Center" ToolTip="When enabled, the assistant will respond in plain text like ChatGPT." />
                <ComboBox x:Name="PromptSamples" Width="240" Height="26" SelectedIndex="-1" SelectionChanged="PromptSamples_SelectionChanged">
                    <ComboBoxItem>What is the biggest animal in the world?</ComboBoxItem>
                    <ComboBoxItem>Explain photosynthesis in simple terms.</ComboBoxItem>
                    <ComboBoxItem>How do I prepare for multiple choice exams?</ComboBoxItem>
                </ComboBox>
            </StackPanel>

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox x:Name="InputBox" Grid.Column="0" Height="36" VerticalAlignment="Center" Text="" AcceptsReturn="False" TextWrapping="NoWrap" KeyDown="InputBox_KeyDown" HorizontalAlignment="Stretch" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBool}}" />
                <Button Content="Send" Grid.Column="1" Width="80" Height="36" Margin="8,0,0,0" Click="Send_Click" IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBool}}" />
            </Grid>
        </StackPanel>

        <Grid Grid.Row="2" Margin="0,8,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="Text size:" VerticalAlignment="Center" Margin="0,0,6,0" />
                <Slider Minimum="11" Maximum="22" Width="140" Value="{Binding MessageFontSize, Mode=TwoWay}" SmallChange="1" LargeChange="2" TickFrequency="1" IsSnapToTickEnabled="True" />
                <Button Content="Enlarge" Width="80" Margin="8,0,0,0" Click="Enlarge_Click" />
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Show raw response" Width="140" Click="ShowRaw_Click" Style="{StaticResource SecondaryButton}" Margin="0,0,8,0" />
                <Button Content="Clear" Width="80" Click="Clear_Click" Style="{StaticResource SecondaryButton}" />
                <Button Content="Close" Width="80" Click="Close_Click" Style="{StaticResource SecondaryButton}" Margin="8,0,0,0" />
            </StackPanel>
        </Grid>
    </Grid>
</Window>